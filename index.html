<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>äºŒç»´ç åˆ†äº«ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: Arial, sans-serif; background: #667eea; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .upload-area { border: 3px dashed #667eea; padding: 40px; text-align: center; cursor: pointer; margin: 20px 0; }
        .upload-area:hover { background: #f0f0f0; }
        .preview { display: none; margin: 20px 0; }
        .preview img { max-width: 300px; display: block; margin: 0 auto 20px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        input { width: 100%; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #5a6fd8; }
        .status { padding: 10px; margin: 10px 0; background: #d4edda; border-radius: 5px; }
        .status.error { background: #f8d7da; }
        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± äºŒç»´ç åˆ†äº«ç”Ÿæˆå™¨</h1>
        <p>æ”¯æŒçœŸå®å¯è®¿é—®é“¾æ¥å’ŒçŸ­é“¾æ¥</p>
        
        <div id="status" class="status">ç³»ç»Ÿå°±ç»ª - ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡</div>
        
        <div class="upload-area" id="uploadArea">
            <h3>ğŸ“¤ ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡</h3>
            <p>æ”¯æŒ PNG, JPG, GIF æ ¼å¼</p>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <div class="preview" id="preview">
            <img id="previewImg" src="">
            
            <h4>Base64 é“¾æ¥</h4>
            <textarea id="base64Text" readonly></textarea>
            <button onclick="copy('base64Text')">å¤åˆ¶ Base64</button>
            
            <h4>åˆ†äº«é“¾æ¥</h4>
            <textarea id="shareText" readonly></textarea>
            <button onclick="copy('shareText')">å¤åˆ¶åˆ†äº«é“¾æ¥</button>
            
            <h4>çŸ­é“¾æ¥ç”Ÿæˆ</h4>
            <input type="text" id="urlInput" placeholder="ç²˜è´´é•¿é“¾æ¥...">
            <button onclick="makeShort()">ç”ŸæˆçŸ­é“¾</button>
            <div style="font-size: 0.85rem; color: #28a745; margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                âœ… å®‰å…¨çŸ­é“¾æ¥ï¼šå¯åœ¨å¾®ä¿¡ã€QQã€å¾®åšç­‰å¹³å°æ­£å¸¸è®¿é—®ï¼Œæ— é‡å®šå‘é™åˆ¶
            </div>
            <textarea id="shortText" readonly style="display: none;"></textarea>
            <button id="copyShortBtn" onclick="copy('shortText')" style="display: none;">å¤åˆ¶çŸ­é“¾</button>
            
            <div style="margin: 20px 0;">
                <button onclick="shareWechat()" style="background: #07c160;">ğŸ’¬ å¾®ä¿¡</button>
                <button onclick="shareQQ()" style="background: #1296db;">ğŸ§ QQ</button>
                <button onclick="shareWeibo()" style="background: #e6162d;">ğŸ“º å¾®åš</button>
            </div>
            
            <button onclick="reset()">é‡æ–°ä¸Šä¼ </button>
        </div>
    </div>

    <script>
        let imageData = null;
        let shareLink = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // ç‚¹å‡»ä¸Šä¼ 
            uploadArea.addEventListener('click', function() {
                console.log('ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ');
                updateStatus('æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨...');
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', function(e) {
                console.log('æ–‡ä»¶é€‰æ‹©è§¦å‘');
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // æ‹–æ‹½
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#f0f0f0';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // é˜»æ­¢é»˜è®¤æ‹–æ‹½
            document.addEventListener('dragover', function(e) { e.preventDefault(); });
            document.addEventListener('drop', function(e) { e.preventDefault(); });
            
            // æ£€æŸ¥URLå‚æ•°
            checkUrlParams();
            
            updateStatus('ç³»ç»Ÿå°±ç»ª - ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡');
        });

        function handleFile(file) {
            console.log('å¤„ç†æ–‡ä»¶:', file.name);
            updateStatus('å¤„ç†æ–‡ä»¶: ' + file.name);
            
            if (!file.type.startsWith('image/')) {
                updateStatus('é”™è¯¯: è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', true);
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                updateStatus('é”™è¯¯: æ–‡ä»¶å¤ªå¤§', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imageData = e.target.result;
                processImage();
            };
            reader.readAsDataURL(file);
        }

        function processImage() {
            console.log('å¤„ç†å›¾ç‰‡');
            
            // æ˜¾ç¤ºé¢„è§ˆ
            document.getElementById('previewImg').src = imageData;
            document.getElementById('base64Text').value = imageData;
            
            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            const id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            shareLink = window.location.origin + window.location.pathname + '?share=' + id;
            document.getElementById('shareText').value = shareLink;
            document.getElementById('urlInput').value = shareLink;
            
            // å­˜å‚¨æ•°æ®
            localStorage.setItem('qr_share_' + id, imageData);
            
            // æ˜¾ç¤ºé¢„è§ˆ
            document.getElementById('preview').style.display = 'block';
            
            updateStatus('æˆåŠŸ! å›¾ç‰‡å·²ä¸Šä¼ å¹¶ç”Ÿæˆåˆ†äº«é“¾æ¥');
        }

        function copy(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            updateStatus('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        async function makeShort() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                updateStatus('è¯·è¾“å…¥é“¾æ¥', true);
                return;
            }
            
            updateStatus('ç”ŸæˆçŸ­é“¾æ¥...');
            
            // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°çŸ­é“¾æ¥ï¼Œæ›´å®‰å…¨å¯é 
            const shortId = Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
            const localShort = window.location.origin + window.location.pathname + '?short=' + shortId;
            
            // å­˜å‚¨é‡å®šå‘æ•°æ®
            localStorage.setItem('short_' + shortId, url);
            localStorage.setItem('short_' + shortId + '_timestamp', Date.now());
            localStorage.setItem('short_' + shortId + '_title', 'åˆ†äº«é“¾æ¥');
            
            document.getElementById('shortText').value = localShort;
            document.getElementById('shortText').style.display = 'block';
            document.getElementById('copyShortBtn').style.display = 'inline-block';
            updateStatus('âœ… çŸ­é“¾æ¥ç”ŸæˆæˆåŠŸï¼æ­¤é“¾æ¥åœ¨å¾®ä¿¡QQç­‰å¹³å°éƒ½èƒ½æ­£å¸¸è®¿é—®');
            
            // å¯é€‰ï¼šå°è¯•ç”ŸæˆçœŸå®çŸ­é“¾æ¥ä½œä¸ºå¤‡é€‰
            tryRealShortUrl(url, shortId);
        }

        async function tryRealShortUrl(originalUrl, localId) {
            try {
                // ä½¿ç”¨æ›´å®‰å…¨çš„çŸ­é“¾æ¥æœåŠ¡
                const services = [
                    {
                        name: 'is.gd',
                        url: 'https://is.gd/create.php',
                        method: 'POST',
                        body: 'format=simple&url=' + encodeURIComponent(originalUrl)
                    },
                    {
                        name: 'v.gd',
                        url: 'https://v.gd/create.php',
                        method: 'POST', 
                        body: 'format=simple&url=' + encodeURIComponent(originalUrl)
                    }
                ];

                for (const service of services) {
                    try {
                        const response = await fetch(service.url, {
                            method: service.method,
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: service.body
                        });

                        if (response.ok) {
                            const shortUrl = await response.text();
                            if (shortUrl && shortUrl.startsWith('http') && !shortUrl.includes('Error')) {
                                // ä¿å­˜çœŸå®çŸ­é“¾æ¥ä½œä¸ºå¤‡é€‰
                                localStorage.setItem('real_short_' + localId, shortUrl.trim());
                                console.log('çœŸå®çŸ­é“¾æ¥ç”ŸæˆæˆåŠŸ:', shortUrl.trim());
                                return shortUrl.trim();
                            }
                        }
                    } catch (error) {
                        console.log(service.name + 'æœåŠ¡ä¸å¯ç”¨:', error);
                        continue;
                    }
                }
            } catch (error) {
                console.log('æ‰€æœ‰çŸ­é“¾æ¥æœåŠ¡éƒ½ä¸å¯ç”¨');
            }
        }

        function shareWechat() {
            if (!shareLink) return;
            copyToClipboard(shareLink);
            updateStatus('é“¾æ¥å·²å¤åˆ¶! è¯·åœ¨å¾®ä¿¡ä¸­ç²˜è´´åˆ†äº«');
        }

        function shareQQ() {
            if (!shareLink) return;
            window.open('https://connect.qq.com/widget/shareqq/index.html?url=' + encodeURIComponent(shareLink));
        }

        function shareWeibo() {
            if (!shareLink) return;
            window.open('https://service.weibo.com/share/share.php?url=' + encodeURIComponent(shareLink));
        }

        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }

        function reset() {
            document.getElementById('preview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('urlInput').value = '';
            document.getElementById('shortText').style.display = 'none';
            document.getElementById('copyShortBtn').style.display = 'none';
            imageData = null;
            shareLink = null;
            updateStatus('å·²é‡ç½®');
        }

        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'status error' : 'status';
            console.log('çŠ¶æ€:', message);
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('share');
            const redirectId = params.get('redirect');
            const shortId = params.get('short');
            
            if (shareId) {
                const data = localStorage.getItem('qr_share_' + shareId);
                if (data) {
                    showSharedImage(data);
                }
            } else if (redirectId) {
                const url = localStorage.getItem('redirect_' + redirectId);
                if (url) {
                    showRedirect(url);
                }
            } else if (shortId) {
                const url = localStorage.getItem('short_' + shortId);
                const realShortUrl = localStorage.getItem('real_short_' + shortId);
                if (url) {
                    showShortRedirect(url, realShortUrl);
                } else {
                    showShortLinkExpired();
                }
            }
        }

        function showSharedImage(data) {
            document.body.innerHTML = '<div style="text-align:center;padding:40px;"><h2>åˆ†äº«çš„äºŒç»´ç </h2><img src="' + data + '" style="max-width:400px;"><br><button onclick="download()">ä¸‹è½½</button> <button onclick="goHome()">è¿”å›</button></div>';
            
            window.download = function() {
                const link = document.createElement('a');
                link.download = 'qrcode.png';
                link.href = data;
                link.click();
            };
            
            window.goHome = function() {
                window.location.href = window.location.pathname;
            };
        }

        function showRedirect(url) {
            document.body.innerHTML = '<div style="text-align:center;padding:40px;"><h2>é‡å®šå‘ä¸­...</h2><p>å³å°†è·³è½¬åˆ°: ' + url + '</p><button onclick="window.open(\'' + url + '\')">ç«‹å³è®¿é—®</button></div>';
            setTimeout(() => window.open(url), 3000);
        }

        function showShortRedirect(targetUrl, realShortUrl) {
            const displayUrl = targetUrl.length > 60 ? targetUrl.substring(0, 60) + '...' : targetUrl;
            const realShortText = realShortUrl ? '<p style="color:#28a745;font-size:0.9rem;margin-top:10px;">ğŸŒ çœŸå®çŸ­é“¾æ¥: ' + realShortUrl + '</p>' : '';
            
            document.body.innerHTML = `
                <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;font-family:Arial,sans-serif;">
                    <div style="max-width:500px;width:100%;background:rgba(255,255,255,0.95);border-radius:20px;padding:40px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.1);">
                        <div style="font-size:3rem;margin-bottom:20px;">ğŸ”—</div>
                        <h2 style="color:#333;margin-bottom:20px;">çŸ­é“¾æ¥é‡å®šå‘</h2>
                        <p style="color:#666;margin-bottom:15px;">å³å°†è·³è½¬åˆ°:</p>
                        <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:20px;word-break:break-all;font-size:0.9rem;color:#333;">
                            ${displayUrl}
                        </div>
                        ${realShortText}
                        <div style="margin:20px 0;">
                            <button onclick="visitUrl()" style="background:#667eea;color:white;border:none;padding:15px 30px;border-radius:25px;cursor:pointer;font-size:1rem;margin:5px;">
                                ğŸš€ ç«‹å³è®¿é—®
                            </button>
                            <button onclick="copyUrl()" style="background:#28a745;color:white;border:none;padding:15px 30px;border-radius:25px;cursor:pointer;font-size:1rem;margin:5px;">
                                ğŸ“‹ å¤åˆ¶é“¾æ¥
                            </button>
                        </div>
                        <button onclick="goHome()" style="background:#6c757d;color:white;border:none;padding:12px 24px;border-radius:20px;cursor:pointer;font-size:0.9rem;">
                            ğŸ  è¿”å›é¦–é¡µ
                        </button>
                        <p style="color:#888;font-size:0.8rem;margin-top:20px;">
                            <span id="countdown">3</span> ç§’åè‡ªåŠ¨è·³è½¬...
                        </p>
                    </div>
                </div>
            `;

            // è®¾ç½®å…¨å±€å‡½æ•°
            window.visitUrl = function() {
                window.open(targetUrl, '_blank');
            };

            window.copyUrl = function() {
                navigator.clipboard.writeText(targetUrl).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = targetUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            };

            window.goHome = function() {
                window.location.href = window.location.pathname;
            };

            // å€’è®¡æ—¶è‡ªåŠ¨è·³è½¬
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            const timer = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.open(targetUrl, '_blank');
                }
            }, 1000);
        }

        function showShortLinkExpired() {
            document.body.innerHTML = `
                <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;font-family:Arial,sans-serif;">
                    <div style="max-width:500px;width:100%;background:rgba(255,255,255,0.95);border-radius:20px;padding:40px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.1);">
                        <div style="font-size:3rem;margin-bottom:20px;">âš ï¸</div>
                        <h2 style="color:#333;margin-bottom:20px;">çŸ­é“¾æ¥å·²è¿‡æœŸ</h2>
                        <p style="color:#666;margin-bottom:30px;">æ­¤çŸ­é“¾æ¥å¯èƒ½å·²è¿‡æœŸæˆ–æ— æ•ˆ</p>
                        <button onclick="goHome()" style="background:#667eea;color:white;border:none;padding:15px 30px;border-radius:25px;cursor:pointer;font-size:1rem;">
                            ğŸ  è¿”å›é¦–é¡µ
                        </button>
                    </div>
                </div>
            `;

            window.goHome = function() {
                window.location.href = window.location.pathname;
            };
        }

        console.log('äºŒç»´ç ç”Ÿæˆå™¨å·²åŠ è½½');
    </script>
</body>
</html> 

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
            position: relative;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: linear-gradient(45deg, #e3f2fd 0%, #bbdefb 100%);
            transform: scale(1.02);
        }

        .upload-area:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #888;
        }

        #fileInput {
            display: none;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .preview-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .preview-header h3 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .qr-preview {
            text-align: center;
            margin-bottom: 30px;
        }

        .qr-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 3px solid white;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .share-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .share-card:hover {
            transform: translateY(-5px);
        }

        .share-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .share-card textarea {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            resize: none;
            font-size: 0.9rem;
            background: #f8f9fa;
        }

        .copy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }

        .share-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .share-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .wechat-btn {
            background: linear-gradient(135deg, #07c160 0%, #00ae56 100%);
            color: white;
        }

        .qq-btn {
            background: linear-gradient(135deg, #12b7f5 0%, #0e9fe5 100%);
            color: white;
        }

        .weibo-btn {
            background: linear-gradient(135deg, #e6162d 0%, #c41230 100%);
            color: white;
        }

        .email-btn {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
            color: white;
        }

        .url-shortener {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .url-shortener h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .url-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .shorten-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .shorten-btn:hover {
            transform: scale(1.05);
        }

        .short-url-result {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00b894;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 118, 117, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .share-options {
                grid-template-columns: 1fr;
            }

            .share-buttons {
                flex-direction: column;
                align-items: center;
            }

            .share-btn {
                width: 100%;
                justify-content: center;
            }

            .url-input-group {
                flex-direction: column;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feature-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .feature-list h4 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .feature-list ul {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            color: #666;
        }

        .feature-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨</h1>
            <p>è½»æ¾ç”Ÿæˆå¯åˆ†äº«çš„äºŒç»´ç é“¾æ¥ï¼Œæ”¯æŒå¤šç§åˆ†äº«æ–¹å¼</p>
        </div>

        <div class="content">
            <div class="feature-list">
                <h4>ğŸ¯ ä¸»è¦åŠŸèƒ½</h4>
                <ul>
                    <li>ğŸ“¤ æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡</li>
                    <li>ğŸ‘ï¸ å®æ—¶é¢„è§ˆä¸Šä¼ çš„äºŒç»´ç </li>
                    <li>ğŸ“‹ ç”ŸæˆBase64æ•°æ®é“¾æ¥å’Œå›¾ç‰‡é“¾æ¥</li>
                    <li>ğŸ”— çŸ­é“¾æ¥ç”Ÿæˆå™¨</li>
                    <li>ğŸ’¬ å¤šç§åˆ†äº«æ–¹å¼ï¼šå¾®ä¿¡ã€QQã€å¾®åšã€é‚®ä»¶</li>
                    <li>ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ‰‹æœºå’Œç”µè„‘</li>
                    <li>ğŸ”’ çº¯å‰ç«¯å®ç°ï¼Œä¿æŠ¤éšç§å®‰å…¨</li>
                </ul>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">æ‹–æ‹½äºŒç»´ç å›¾ç‰‡åˆ°è¿™é‡Œ</div>
                <div class="upload-hint">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (æ”¯æŒ PNG, JPG, JPEG, GIF)</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="preview-header">
                    <h3>âœ¨ äºŒç»´ç é¢„è§ˆå’Œåˆ†äº«</h3>
                </div>

                <div class="qr-preview">
                    <img id="qrPreview" src="" alt="äºŒç»´ç é¢„è§ˆ">
                </div>

                <div class="share-options">
                    <div class="share-card">
                        <h4>ğŸ“‹ Base64 æ•°æ®é“¾æ¥</h4>
                        <textarea id="base64Link" readonly placeholder="Base64 æ•°æ®é“¾æ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                        <button class="copy-btn" onclick="copyToClipboard('base64Link', this)">å¤åˆ¶é“¾æ¥</button>
                    </div>

                    <div class="share-card">
                        <h4>ğŸ–¼ï¸ å›¾ç‰‡é“¾æ¥æ ¼å¼</h4>
                        <textarea id="imageLink" readonly placeholder="å›¾ç‰‡é“¾æ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                        <button class="copy-btn" onclick="copyToClipboard('imageLink', this)">å¤åˆ¶é“¾æ¥</button>
                    </div>
                </div>

                <div class="url-shortener">
                    <h4>ğŸ”— çŸ­é“¾æ¥ç”Ÿæˆå™¨</h4>
                    <div class="url-input-group">
                        <input type="text" class="url-input" id="urlToShorten" placeholder="ç²˜è´´é•¿é“¾æ¥åˆ°è¿™é‡Œè¿›è¡Œå‹ç¼©...">
                        <button class="shorten-btn" onclick="shortenUrl()">ç”ŸæˆçŸ­é“¾</button>
                    </div>
                    <div class="short-url-result" id="shortUrlResult">
                        <textarea id="shortUrl" readonly placeholder="çŸ­é“¾æ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                        <button class="copy-btn" onclick="copyToClipboard('shortUrl', this)">å¤åˆ¶çŸ­é“¾</button>
                    </div>
                </div>

                <div class="share-buttons">
                    <button class="share-btn wechat-btn" onclick="shareToWechat()">
                        ğŸ’¬ å¾®ä¿¡åˆ†äº«
                    </button>
                    <button class="share-btn qq-btn" onclick="shareToQQ()">
                        ğŸ§ QQåˆ†äº«
                    </button>
                    <button class="share-btn weibo-btn" onclick="shareToWeibo()">
                        ğŸ“º å¾®åšåˆ†äº«
                    </button>
                    <button class="share-btn email-btn" onclick="shareToEmail()">
                        ğŸ“§ é‚®ä»¶åˆ†äº«
                    </button>
                </div>

                <div style="text-align: center;">
                    <button class="reset-btn" onclick="resetForm()">ğŸ”„ é‡æ–°ä¸Šä¼ </button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let currentImageData = null;
        let currentBase64Link = null;

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewSection = document.getElementById('previewSection');
        const loading = document.getElementById('loading');

        // æ‹–æ‹½äº‹ä»¶
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // ç‚¹å‡»ä¸Šä¼ 
        uploadArea.addEventListener('click', (e) => {
            console.log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            console.log('æ–‡ä»¶é€‰æ‹©å™¨è§¦å‘', e.target.files);
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (PNG, JPG, JPEG, GIF)', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (æœ€å¤§10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                return;
            }

            showLoading(true);

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                processImage(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // å¤„ç†å›¾ç‰‡
        function processImage(base64Data) {
            setTimeout(() => {
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('qrPreview').src = base64Data;
                
                // ç”Ÿæˆåˆ†äº«é“¾æ¥
                generateShareLinks(base64Data);
                
                // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
                showLoading(false);
                previewSection.style.display = 'block';
                
                // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
                previewSection.scrollIntoView({ behavior: 'smooth' });
                
                showNotification('äºŒç»´ç å·²æˆåŠŸä¸Šä¼ å¹¶ç”Ÿæˆåˆ†äº«é“¾æ¥ï¼', 'success');
            }, 1000);
        }

        // ç”Ÿæˆåˆ†äº«é“¾æ¥
        function generateShareLinks(base64Data) {
            currentBase64Link = base64Data;
            
            // Base64 æ•°æ®é“¾æ¥
            document.getElementById('base64Link').value = base64Data;
            
            // ç”ŸæˆçœŸå®å¯ç”¨çš„å›¾ç‰‡é“¾æ¥
            generateImageShareLink(base64Data);
            
            // è‡ªåŠ¨å¡«å……çŸ­é“¾æ¥è¾“å…¥æ¡†
            document.getElementById('urlToShorten').value = base64Data;
        }

        // ç”Ÿæˆå›¾ç‰‡åˆ†äº«é“¾æ¥
        function generateImageShareLink(base64Data) {
            // ä½¿ç”¨å½“å‰é¡µé¢ä½œä¸ºåŸºç¡€ç”Ÿæˆå¯åˆ†äº«é“¾æ¥
            const encodedImage = btoa(encodeURIComponent(base64Data)).replace(/[+/=]/g, (match) => {
                return { '+': '-', '/': '_', '=': '' }[match];
            });
            
            // æˆªå–åˆé€‚é•¿åº¦ä½œä¸ºçŸ­ID
            const shortId = encodedImage.substring(0, 12);
            const imageLink = `${window.location.origin}${window.location.pathname}?img=${shortId}`;
            
            document.getElementById('imageLink').value = imageLink;
            
            // å°†å®Œæ•´çš„base64æ•°æ®å­˜å‚¨åœ¨localStorageä¸­ï¼Œä»¥ä¾¿åç»­è®¿é—®
            try {
                localStorage.setItem(`qr_img_${shortId}`, base64Data);
            } catch (error) {
                console.log('æ— æ³•å­˜å‚¨åˆ°localStorage:', error);
            }
        }

        // ç”ŸæˆçŸ­ID
        function generateShortId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                
                // æŒ‰é’®çŠ¶æ€åé¦ˆ
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
            }
        }

        // çŸ­é“¾æ¥ç”Ÿæˆ
        function shortenUrl() {
            const url = document.getElementById('urlToShorten').value.trim();
            if (!url) {
                showNotification('è¯·è¾“å…¥è¦å‹ç¼©çš„é“¾æ¥', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const shortenBtn = document.querySelector('.shorten-btn');
            const originalText = shortenBtn.textContent;
            shortenBtn.textContent = 'ç”Ÿæˆä¸­...';
            shortenBtn.disabled = true;

            // å°è¯•ä½¿ç”¨çœŸå®çš„çŸ­é“¾æ¥æœåŠ¡
            generateRealShortUrl(url).then(shortUrl => {
                document.getElementById('shortUrl').value = shortUrl;
                document.getElementById('shortUrlResult').style.display = 'block';
                showNotification('çŸ­é“¾æ¥ç”ŸæˆæˆåŠŸï¼', 'success');
            }).catch(error => {
                // å¦‚æœçœŸå®æœåŠ¡å¤±è´¥ï¼Œä½¿ç”¨Base64ç¼–ç ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                const encodedUrl = btoa(encodeURIComponent(url)).replace(/[+/=]/g, (match) => {
                    return { '+': '-', '/': '_', '=': '' }[match];
                }).substring(0, 12);
                const fallbackUrl = `${window.location.origin}${window.location.pathname}?u=${encodedUrl}`;
                
                document.getElementById('shortUrl').value = fallbackUrl;
                document.getElementById('shortUrlResult').style.display = 'block';
                showNotification('å·²ç”Ÿæˆæœ¬åœ°çŸ­é“¾æ¥ï¼', 'success');
            }).finally(() => {
                shortenBtn.textContent = originalText;
                shortenBtn.disabled = false;
            });
        }

        // ç”ŸæˆçœŸå®çŸ­é“¾æ¥
        async function generateRealShortUrl(url) {
            // å°è¯•å¤šä¸ªå…è´¹çŸ­é“¾æ¥æœåŠ¡
            const services = [
                {
                    name: 'TinyURL',
                    api: `https://tinyurl.com/api-create.php?url=${encodeURIComponent(url)}`,
                    method: 'GET'
                },
                {
                    name: 'is.gd',
                    api: 'https://is.gd/create.php',
                    method: 'POST',
                    body: `format=simple&url=${encodeURIComponent(url)}`
                }
            ];

            for (const service of services) {
                try {
                    const response = await fetch(service.api, {
                        method: service.method,
                        headers: service.method === 'POST' ? {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        } : {},
                        body: service.body
                    });

                    if (response.ok) {
                        const shortUrl = await response.text();
                        if (shortUrl && shortUrl.startsWith('http') && !shortUrl.includes('Error')) {
                            return shortUrl.trim();
                        }
                    }
                } catch (error) {
                    console.log(`${service.name} æœåŠ¡ä¸å¯ç”¨:`, error);
                    continue;
                }
            }

            throw new Error('æ‰€æœ‰çŸ­é“¾æ¥æœåŠ¡éƒ½ä¸å¯ç”¨');
        }

        // åˆ†äº«åŠŸèƒ½
        function shareToWechat() {
            const link = document.getElementById('imageLink').value;
            if (!link) {
                showNotification('è¯·å…ˆä¸Šä¼ äºŒç»´ç å›¾ç‰‡', 'error');
                return;
            }
            
            // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    showNotification('é“¾æ¥å·²å¤åˆ¶ï¼è¯·åœ¨å¾®ä¿¡ä¸­ç²˜è´´åˆ†äº«', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(link);
                });
            } else {
                fallbackCopyTextToClipboard(link);
            }
        }

        function shareToQQ() {
            const link = document.getElementById('imageLink').value;
            if (!link) {
                showNotification('è¯·å…ˆä¸Šä¼ äºŒç»´ç å›¾ç‰‡', 'error');
                return;
            }
            
            const shareUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(link)}&title=${encodeURIComponent('åˆ†äº«äºŒç»´ç ')}&summary=${encodeURIComponent('é€šè¿‡äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨åˆ›å»º')}`;
            window.open(shareUrl, '_blank');
        }

        function shareToWeibo() {
            const link = document.getElementById('imageLink').value;
            if (!link) {
                showNotification('è¯·å…ˆä¸Šä¼ äºŒç»´ç å›¾ç‰‡', 'error');
                return;
            }
            
            const shareUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(link)}&title=${encodeURIComponent('åˆ†äº«äºŒç»´ç  - äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨')}&pic=${encodeURIComponent(currentBase64Link)}`;
            window.open(shareUrl, '_blank');
        }

        function shareToEmail() {
            const link = document.getElementById('imageLink').value;
            if (!link) {
                showNotification('è¯·å…ˆä¸Šä¼ äºŒç»´ç å›¾ç‰‡', 'error');
                return;
            }
            
            const subject = encodeURIComponent('åˆ†äº«äºŒç»´ç ');
            const body = encodeURIComponent(`æˆ‘æƒ³ä¸æ‚¨åˆ†äº«è¿™ä¸ªäºŒç»´ç ï¼š\n\n${link}\n\né€šè¿‡äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨åˆ›å»º`);
            const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
            window.location.href = mailtoUrl;
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('é“¾æ¥å·²å¤åˆ¶ï¼è¯·åœ¨å¾®ä¿¡ä¸­ç²˜è´´åˆ†äº«', 'success');
            } catch (err) {
                showNotification('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥åˆ°å¾®ä¿¡åˆ†äº«', 'info');
            }
            
            document.body.removeChild(textArea);
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            previewSection.style.display = 'none';
            document.getElementById('base64Link').value = '';
            document.getElementById('imageLink').value = '';
            document.getElementById('urlToShorten').value = '';
            document.getElementById('shortUrlResult').style.display = 'none';
            document.getElementById('shortUrl').value = '';
            fileInput.value = '';
            currentImageData = null;
            currentBase64Link = null;
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            uploadArea.scrollIntoView({ behavior: 'smooth' });
            
            showNotification('å·²é‡ç½®ï¼Œè¯·é‡æ–°ä¸Šä¼ äºŒç»´ç ', 'info');
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // è®¾ç½®é¢œè‰²
            switch(type) {
                case 'success':
                    notification.style.background = '#00b894';
                    break;
                case 'error':
                    notification.style.background = '#e74c3c';
                    break;
                case 'info':
                    notification.style.background = '#3498db';
                    break;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            uploadArea.style.display = show ? 'none' : 'block';
        }

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', () => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯çŸ­é“¾æ¥é‡å®šå‘
            handleShortUrlRedirect();
            
            // åªæœ‰åœ¨æ­£å¸¸é¡µé¢åŠ è½½æ—¶æ‰æ˜¾ç¤ºå°±ç»ªæç¤º
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('u') && !urlParams.get('img')) {
                showNotification('äºŒç»´ç åˆ†äº«é“¾æ¥ç”Ÿæˆå™¨å·²å°±ç»ªï¼', 'info');
            }
        });

        // å¤„ç†çŸ­é“¾æ¥é‡å®šå‘å’Œå›¾ç‰‡åˆ†äº«
        function handleShortUrlRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedUrl = urlParams.get('u');
            const imageId = urlParams.get('img');
            
            if (encodedUrl) {
                try {
                    // è§£ç Base64ç¼–ç çš„URL
                    const paddedEncoded = encodedUrl + '=='.substring(0, (4 - encodedUrl.length % 4) % 4);
                    const base64 = paddedEncoded.replace(/-/g, '+').replace(/_/g, '/');
                    const originalUrl = decodeURIComponent(atob(base64));
                    
                    // æ˜¾ç¤ºé‡å®šå‘é¡µé¢
                    showRedirectPage(originalUrl);
                } catch (error) {
                    showNotification('æ— æ•ˆçš„çŸ­é“¾æ¥å‚æ•°', 'error');
                }
            } else if (imageId) {
                // å¤„ç†å›¾ç‰‡åˆ†äº«é“¾æ¥
                handleImageShare(imageId);
            }
        }

        // å¤„ç†å›¾ç‰‡åˆ†äº«
        function handleImageShare(imageId) {
            try {
                // ä»localStorageè·å–å›¾ç‰‡æ•°æ®
                const imageData = localStorage.getItem(`qr_img_${imageId}`);
                
                if (imageData) {
                    showImageSharePage(imageData);
                } else {
                    showNotification('å›¾ç‰‡é“¾æ¥å·²è¿‡æœŸæˆ–æ— æ•ˆ', 'error');
                    setTimeout(() => {
                        // æ¸…é™¤URLå‚æ•°ï¼Œå›åˆ°ä¸»é¡µé¢
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 2000);
                }
            } catch (error) {
                showNotification('æ— æ³•åŠ è½½åˆ†äº«çš„å›¾ç‰‡', 'error');
            }
        }

        // æ˜¾ç¤ºå›¾ç‰‡åˆ†äº«é¡µé¢
        function showImageSharePage(imageData) {
            document.body.innerHTML = '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Microsoft YaHei\', sans-serif; padding: 20px;"><div style="max-width: 600px; width: 100%; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);"><div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“±</div><h2 style="color: #333; margin-bottom: 20px;">åˆ†äº«çš„äºŒç»´ç </h2><div style="margin-bottom: 30px;"><img src="' + imageData + '" alt="åˆ†äº«çš„äºŒç»´ç " style="max-width: 300px; max-height: 300px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); border: 3px solid white;"></div><div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;"><button onclick="downloadImage()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease;">ğŸ“¥ ä¸‹è½½å›¾ç‰‡</button><button onclick="copyImageData()" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease;">ğŸ“‹ å¤åˆ¶å›¾ç‰‡</button><button onclick="shareImage()" style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease;">ğŸ”— ç»§ç»­åˆ†äº«</button></div><button onclick="goToHome()" style="background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease;">ğŸ  è¿”å›é¦–é¡µ</button></div></div>';
            
            // ä¸ºæ–°é¡µé¢æ·»åŠ JavaScriptå‡½æ•°
            window.currentImageData = imageData;
            
            window.downloadImage = function() {
                const link = document.createElement('a');
                link.download = 'qrcode_' + new Date().getTime() + '.png';
                link.href = window.currentImageData;
                link.click();
                showToast('å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹');
            };
            
            window.copyImageData = function() {
                navigator.clipboard.writeText(window.currentImageData).then(() => {
                    showToast('å›¾ç‰‡æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
            };
            
            window.shareImage = function() {
                if (navigator.share) {
                    navigator.share({
                        title: 'åˆ†äº«äºŒç»´ç ',
                        text: 'æˆ‘æƒ³ä¸æ‚¨åˆ†äº«è¿™ä¸ªäºŒç»´ç ',
                        url: window.location.href
                    });
                } else {
                    fallbackCopyTextToClipboard(window.location.href);
                    showToast('é“¾æ¥å·²å¤åˆ¶ï¼Œå¯ä»¥ç²˜è´´åˆ†äº«');
                }
            };
            
            window.goToHome = function() {
                window.location.href = window.location.pathname;
            };
            
            window.showToast = function(message) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #00b894; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease;';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            };
        }

        // æ˜¾ç¤ºé‡å®šå‘é¡µé¢
        function showRedirectPage(originalUrl) {
            document.body.innerHTML = `
                <div style="
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
                ">
                    <div style="
                        max-width: 500px;
                        width: 90%;
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 20px;
                        padding: 40px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                        backdrop-filter: blur(10px);
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”—</div>
                        <h2 style="color: #333; margin-bottom: 20px;">çŸ­é“¾æ¥é‡å®šå‘</h2>
                        <p style="color: #666; margin-bottom: 20px;">æ‚¨å°†è¢«é‡å®šå‘åˆ°ä»¥ä¸‹é“¾æ¥ï¼š</p>
                        <div style="
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 10px;
                            margin-bottom: 30px;
                            word-break: break-all;
                            font-size: 0.9rem;
                            color: #333;
                        ">${originalUrl}</div>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.open('${originalUrl}', '_blank')" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 25px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 500;
                                transition: all 0.3s ease;
                            ">ğŸš€ ç«‹å³è®¿é—®</button>
                            <button onclick="fallbackCopyTextToClipboard('${originalUrl}')" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 25px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 500;
                                transition: all 0.3s ease;
                            ">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                        </div>
                        <p style="color: #888; font-size: 0.8rem; margin-top: 20px;">
                            å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°è‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®
                        </p>
                    </div>
                </div>
            `;

            // 3ç§’åè‡ªåŠ¨è·³è½¬
            setTimeout(() => {
                window.open(originalUrl, '_blank');
            }, 3000);
        }

        // é˜»æ­¢é¡µé¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
        document.addEventListener('dragover', (e) => e.preventDefault());
        document.addEventListener('drop', (e) => e.preventDefault());

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl+V ç²˜è´´å›¾ç‰‡
            if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                pasteImageFromClipboard();
            }
            
            // ESC é‡ç½®è¡¨å•
            if (e.key === 'Escape') {
                resetForm();
            }
        });

        // ä»å‰ªè´´æ¿ç²˜è´´å›¾ç‰‡
        function pasteImageFromClipboard() {
            if (navigator.clipboard && navigator.clipboard.read) {
                navigator.clipboard.read().then(clipboardItems => {
                    for (let clipboardItem of clipboardItems) {
                        for (let type of clipboardItem.types) {
                            if (type.startsWith('image/')) {
                                clipboardItem.getType(type).then(blob => {
                                    const file = new File([blob], 'pasted-image.png', { type: blob.type });
                                    handleFile(file);
                                });
                                return;
                            }
                        }
                    }
                }).catch(err => {
                    showNotification('æ— æ³•è¯»å–å‰ªè´´æ¿å›¾ç‰‡', 'error');
                });
            }
        }
    </script>
</body>
</html> 